<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Regularized Neural Networks | Daniel Agyapong - ML Researcher </title> <meta name="author" content="Daniel Agyapong"> <meta name="description" content="Implementing a regularized neural network from scratch using PyTorch."> <meta name="keywords" content="machine learning, statistical modeling, microbiome analysis, cross-validation, network inference, bioinformatics, HPC, international research"> <meta property="og:site_name" content="Daniel Agyapong - ML Researcher"> <meta property="og:type" content="website"> <meta property="og:title" content="Daniel Agyapong - ML Researcher | Regularized Neural Networks"> <meta property="og:url" content="https://engineerdanny.github.io/projects/8_project/"> <meta property="og:description" content="Implementing a regularized neural network from scratch using PyTorch."> <meta property="og:locale" content="en"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Regularized Neural Networks"> <meta name="twitter:description" content="Implementing a regularized neural network from scratch using PyTorch."> <script type="application/ld+json">
    {
        "author":
        {
            "@type": "Person",
            "name": "Daniel Agyapong"
        },
        "url": "https://engineerdanny.github.io/projects/8_project/",
        "@type": "WebSite",
        "description": "Implementing a regularized neural network from scratch using PyTorch.",
        "headline": "Regularized Neural Networks",
        
        "sameAs": ["https://orcid.org/0000-0000-0000-0000", "https://scholar.google.com/citations?user=your-scholar-id", "https://www.researchgate.net/profile/Daniel-Agyapong", "https://github.com/Engineerdanny", "https://www.linkedin.com/in/engineerdanny"],
        
        "name": "Daniel Agyapong",
        "@context": "https://schema.org"
    }
  </script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://engineerdanny.github.io/projects/8_project/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Daniel Agyapong - ML Researcher </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">Daniel Agyapong </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/awards/">awards </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/presentations/">presentations </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Regularized Neural Networks</h1> <p class="post-description">Implementing a regularized neural network from scratch using PyTorch.</p> </header> <article> <h2 id="introduction">Introduction</h2> <p>Building a machine learning pipeline from scratch can be a daunting task, especially for those new to the field. This project post aims to simplify this process by providing a step-by-step guide to creating a comprehensive machine learning pipeline. We’ll cover everything from data preparation and model building to training, cross-validation, hyperparameter tuning, and visualization of results.</p> <p>In this post, we’ll walk through the Python code necessary to build and evaluate machine learning models using libraries such as <code class="language-plaintext highlighter-rouge">pandas</code>, <code class="language-plaintext highlighter-rouge">numpy</code>, <code class="language-plaintext highlighter-rouge">scikit-learn</code>, <code class="language-plaintext highlighter-rouge">PyTorch</code>, and <code class="language-plaintext highlighter-rouge">plotnine</code>. We will start by importing the essential libraries and creating custom classes for modeling. These classes include a featureless baseline model, a neural network implemented in <code class="language-plaintext highlighter-rouge">PyTorch</code>, and a custom cross-validation class. We will then move on to data preparation, where we’ll preprocess datasets for training and testing.</p> <p>Following data preparation, we’ll train our models using various hyperparameters and generate diagnostic plots to visualize the results. Finally, we will apply our models to different datasets, comparing the performance of multiple algorithms to determine the best approach.</p> <p>By the end of this post, you should have a clear understanding of how to build a robust machine learning pipeline, ready to be adapted and expanded for your specific needs. Let’s dive in!</p> <h2 id="imports">Imports</h2> <p>The first step in any data science project is to import the necessary libraries. These libraries provide the tools for data manipulation, machine learning, and visualization.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">torch</span>
<span class="kn">import</span> <span class="n">plotnine</span> <span class="k">as</span> <span class="n">p9</span>
<span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span> <span class="n">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegressionCV</span>
<span class="kn">from</span> <span class="n">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="n">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
</code></pre></div></div> <h2 id="custom-classes">Custom Classes</h2> <p>From the previous posts, we have created the <code class="language-plaintext highlighter-rouge">FeaturelessModel</code> class is a simple model that predicts the majority class in the training data.</p> <p>The <code class="language-plaintext highlighter-rouge">TorchModel</code> class defines a neural network using PyTorch. It allows for flexible architecture by specifying the number of hidden layers and units per layer.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TorchModel</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">n_hidden_layers</span><span class="p">,</span> <span class="n">units_in_first_layer</span><span class="p">,</span> <span class="n">units_per_hidden_layer</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">TorchModel</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">units_per_layer</span> <span class="o">=</span> <span class="p">[</span><span class="n">units_in_first_layer</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">layer_i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_hidden_layers</span><span class="p">):</span>
            <span class="n">units_per_layer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">units_per_hidden_layer</span><span class="p">)</span>
        <span class="n">units_per_layer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">seq_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">layer_i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">units_per_layer</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">units_in</span> <span class="o">=</span> <span class="n">units_per_layer</span><span class="p">[</span><span class="n">layer_i</span><span class="p">]</span>
            <span class="n">units_out</span> <span class="o">=</span> <span class="n">units_per_layer</span><span class="p">[</span><span class="n">layer_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">seq_args</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">units_in</span><span class="p">,</span> <span class="n">units_out</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">layer_i</span> <span class="o">!=</span> <span class="nf">len</span><span class="p">(</span><span class="n">units_per_layer</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">seq_args</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">ReLU</span><span class="p">())</span>
        <span class="n">self</span><span class="p">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">seq_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">feature_mat</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">stack</span><span class="p">(</span><span class="n">feature_mat</span><span class="p">)</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">NumpyData</code> class converts numpy arrays into a PyTorch dataset, making it easier to work with DataLoader for batch processing.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">NumpyData</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="n">self</span><span class="p">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">features</span><span class="p">[</span><span class="n">item</span><span class="p">,</span> <span class="p">:],</span> <span class="n">self</span><span class="p">.</span><span class="n">labels</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">labels</span><span class="p">)</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">MyCV</code> class handles cross-validation, iterating over parameter grids and tracking the best performing parameters.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyCV</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">estimator</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">estimator</span>
        <span class="n">self</span><span class="p">.</span><span class="n">param_grid</span> <span class="o">=</span> <span class="n">param_grid</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cv</span> <span class="o">=</span> <span class="n">cv</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">train_features</span> <span class="o">=</span> <span class="n">X</span>
        <span class="n">self</span><span class="p">.</span><span class="n">train_labels</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">self</span><span class="p">.</span><span class="n">best_params_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fold_vec</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">cv</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">train_labels</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">best_mean_accuracy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">param_dict</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">param_grid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="p">[</span><span class="n">param_value</span><span class="p">]</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="nf">setattr</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">estimator</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_value</span><span class="p">)</span>
                <span class="n">accuracy_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">loss_df_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">test_fold</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cv</span><span class="p">):</span>
                    <span class="n">is_set_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">validation</span><span class="sh">"</span><span class="p">:</span> <span class="n">fold_vec</span> <span class="o">==</span> <span class="n">test_fold</span><span class="p">,</span> <span class="sh">"</span><span class="s">subtrain</span><span class="sh">"</span><span class="p">:</span> <span class="n">fold_vec</span> <span class="o">!=</span> <span class="n">test_fold</span><span class="p">}</span>
                    <span class="n">set_features</span> <span class="o">=</span> <span class="p">{</span><span class="n">set_name</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">train_features</span><span class="p">[</span><span class="n">is_set</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">set_name</span><span class="p">,</span> <span class="n">is_set</span> <span class="ow">in</span> <span class="n">is_set_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
                    <span class="n">set_labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">set_name</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">train_labels</span><span class="p">[</span><span class="n">is_set</span><span class="p">]</span> <span class="k">for</span> <span class="n">set_name</span><span class="p">,</span> <span class="n">is_set</span> <span class="ow">in</span> <span class="n">is_set_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">()}</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">set_features</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">set_labels</span><span class="p">)</span>
                    <span class="n">predicted_labels</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">set_features</span><span class="p">[</span><span class="sh">"</span><span class="s">validation</span><span class="sh">"</span><span class="p">])</span>
                    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">predicted_labels</span> <span class="o">==</span> <span class="n">set_labels</span><span class="p">[</span><span class="sh">"</span><span class="s">validation</span><span class="sh">"</span><span class="p">])</span>
                    <span class="n">loss_df_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">loss_df</span><span class="p">)</span>
                    <span class="n">accuracy_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>
                <span class="n">mean_accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">accuracy_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mean_accuracy</span> <span class="o">&gt;</span> <span class="n">best_mean_accuracy</span><span class="p">:</span>
                    <span class="n">best_mean_accuracy</span> <span class="o">=</span> <span class="n">mean_accuracy</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">best_params_</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_value</span>
                    <span class="nf">setattr</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">estimator</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">best_params_</span><span class="p">[</span><span class="n">param_name</span><span class="p">])</span>

        <span class="n">self</span><span class="p">.</span><span class="n">loss_mean_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">loss_df_list</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">loss_mean_df</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</code></pre></div></div> <p>The Regularized Multi-Layer Perceptron(RegularizedMLP) class builds and trains a neural network with regularization. It uses the TorchModel class to define the neural network architecture and the NumpyData class to convert numpy arrays into PyTorch datasets.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RegularizedMLP</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">max_epochs</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">units_per_hidden_layer</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="n">max_epochs</span>
        <span class="n">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="n">self</span><span class="p">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="n">step_size</span>
        <span class="n">self</span><span class="p">.</span><span class="n">units_per_hidden_layer</span> <span class="o">=</span> <span class="n">units_per_hidden_layer</span>
        <span class="n">self</span><span class="p">.</span><span class="n">loss_fun</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">BCEWithLogitsLoss</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">set_features</span> <span class="o">=</span> <span class="n">X</span>
        <span class="n">set_labels</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">subtrain_csv</span> <span class="o">=</span> <span class="nc">NumpyData</span><span class="p">(</span><span class="n">set_features</span><span class="p">[</span><span class="sh">"</span><span class="s">subtrain</span><span class="sh">"</span><span class="p">],</span> <span class="n">set_labels</span><span class="p">[</span><span class="sh">"</span><span class="s">subtrain</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">subtrain_dl</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nc">DataLoader</span><span class="p">(</span><span class="n">subtrain_csv</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">loss_df_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">n_hidden_layers</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_layers</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="nc">TorchModel</span><span class="p">(</span><span class="n">n_hidden_layers</span><span class="p">,</span> <span class="n">set_features</span><span class="p">[</span><span class="sh">"</span><span class="s">subtrain</span><span class="sh">"</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">SGD</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">max_epochs</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">batch_features</span><span class="p">,</span> <span class="n">batch_labels</span> <span class="ow">in</span> <span class="n">subtrain_dl</span><span class="p">:</span>
                    <span class="n">pred_tensor</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">batch_features</span><span class="p">.</span><span class="nf">float</span><span class="p">()).</span><span class="nf">reshape</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">batch_labels</span><span class="p">.</span><span class="nf">float</span><span class="p">()))</span>
                    <span class="n">loss_tensor</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">loss_fun</span><span class="p">(</span><span class="n">pred_tensor</span><span class="p">,</span> <span class="n">batch_labels</span><span class="p">.</span><span class="nf">float</span><span class="p">())</span>
                    <span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>
                    <span class="n">loss_tensor</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
                    <span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">set_name</span> <span class="ow">in</span> <span class="n">set_features</span><span class="p">:</span>
                    <span class="n">feature_mat</span> <span class="o">=</span> <span class="n">set_features</span><span class="p">[</span><span class="n">set_name</span><span class="p">]</span>
                    <span class="n">label_vec</span> <span class="o">=</span> <span class="n">set_labels</span><span class="p">[</span><span class="n">set_name</span><span class="p">]</span>
                    <span class="n">feature_mat_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">feature_mat</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">))</span>
                    <span class="n">label_vec_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">label_vec</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">))</span>
                    <span class="n">pred_tensor</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">feature_mat_tensor</span><span class="p">.</span><span class="nf">float</span><span class="p">()).</span><span class="nf">reshape</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">label_vec_tensor</span><span class="p">.</span><span class="nf">float</span><span class="p">()))</span>
                    <span class="n">loss_tensor</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">loss_fun</span><span class="p">(</span><span class="n">pred_tensor</span><span class="p">,</span> <span class="n">label_vec_tensor</span><span class="p">.</span><span class="nf">float</span><span class="p">())</span>
                    <span class="n">set_loss</span> <span class="o">=</span> <span class="n">loss_tensor</span><span class="p">.</span><span class="nf">item</span><span class="p">()</span>
                    <span class="n">loss_df_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">n_hidden_layers</span><span class="sh">"</span><span class="p">:</span> <span class="n">n_hidden_layers</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">set_name</span><span class="sh">"</span><span class="p">:</span> <span class="n">set_name</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">:</span> <span class="n">set_loss</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">epoch</span><span class="sh">"</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
                    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">self</span><span class="p">.</span><span class="n">loss_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">loss_df_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decision_function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nc">Tensor</span><span class="p">(</span><span class="n">X</span><span class="p">)).</span><span class="nf">numpy</span><span class="p">().</span><span class="nf">ravel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">decision_function</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div> <h1 id="data-preparation">Data Preparation</h1> <p>Load and preprocess the datasets (spam and zip code data).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">spam_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">"</span><span class="s">./data/spam.data</span><span class="sh">"</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
<span class="n">spam_features</span> <span class="o">=</span> <span class="n">spam_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">()</span>
<span class="n">spam_scaled_features</span> <span class="o">=</span> <span class="p">(</span><span class="n">spam_features</span> <span class="o">-</span> <span class="n">spam_features</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">spam_features</span><span class="p">.</span><span class="nf">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">spam_labels</span> <span class="o">=</span> <span class="n">spam_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">()</span>

<span class="n">zip_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">"</span><span class="s">./data/zip.test.gz</span><span class="sh">"</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="s"> </span><span class="sh">"</span><span class="p">)</span>
<span class="n">is01</span> <span class="o">=</span> <span class="n">zip_df</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">isin</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">zip01_df</span> <span class="o">=</span> <span class="n">zip_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is01</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">zip_features</span> <span class="o">=</span> <span class="n">zip01_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:].</span><span class="nf">to_numpy</span><span class="p">()</span>
<span class="n">zip_labels</span> <span class="o">=</span> <span class="n">zip01_df</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">()</span>
<span class="n">zip_scaled_features</span> <span class="o">=</span> <span class="p">(</span><span class="n">zip_features</span> <span class="o">-</span> <span class="n">zip_features</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">zip_features</span><span class="p">.</span><span class="nf">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">spam</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">spam_scaled_features</span><span class="p">,</span> <span class="n">spam_labels</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">zip</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">zip_features</span><span class="p">,</span> <span class="n">zip_labels</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div> <h1 id="hyperparameter-training-and-diagnostic-plot">Hyperparameter Training and Diagnostic Plot</h1> <p>Train the models using cross-validation and generate diagnostic plots.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">hyperparameter_training_and_diagnostic_plot</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">data_set</span><span class="p">,</span> <span class="p">(</span><span class="n">input_mat</span><span class="p">,</span> <span class="n">output_vec</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">param_dicts</span> <span class="o">=</span> <span class="p">[{</span><span class="sh">'</span><span class="s">hidden_layers</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">L</span><span class="p">]}</span> <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
        <span class="n">rmlp</span> <span class="o">=</span> <span class="nc">RegularizedMLP</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">units_per_hidden_layer</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">learner_instance</span> <span class="o">=</span> <span class="nc">MyCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">rmlp</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_dicts</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">learner_instance</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">input_mat</span><span class="p">,</span> <span class="n">output_vec</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">learner_instance</span><span class="p">.</span><span class="n">best_params_</span><span class="p">)</span>

        <span class="n">loss_df</span> <span class="o">=</span> <span class="n">learner_instance</span><span class="p">.</span><span class="n">loss_mean_df</span>
        <span class="n">loss_df</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">loss_df</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">get_min</span><span class="p">(</span><span class="n">series_obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">series_obj</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="n">series_obj</span><span class="p">.</span><span class="nf">argmin</span><span class="p">()]</span>

        <span class="n">rows_to_plot</span> <span class="o">=</span> <span class="n">loss_df</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sh">"</span><span class="s">n_hidden_layers</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">set_name</span><span class="sh">"</span><span class="p">])[</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="n">get_min</span><span class="p">)</span>
        <span class="n">layers_plot_data</span> <span class="o">=</span> <span class="n">loss_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">rows_to_plot</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">set_colors</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">subtrain</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">validation</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">gg</span> <span class="o">=</span> <span class="n">p9</span><span class="p">.</span><span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">facet_grid</span><span class="p">(</span><span class="sh">"</span><span class="s">. ~ set_name</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">scale_color_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">set_colors</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">geom_line</span><span class="p">(</span>
                <span class="n">p9</span><span class="p">.</span><span class="nf">aes</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">epoch</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">n_hidden_layers</span><span class="sh">"</span>
                <span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">loss_df</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">geom_point</span><span class="p">(</span>
                <span class="n">p9</span><span class="p">.</span><span class="nf">aes</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">epoch</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">n_hidden_layers</span><span class="sh">"</span>
                <span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">layers_plot_data</span><span class="p">)</span>
        <span class="n">gg</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">./11_regularization/</span><span class="si">{</span><span class="n">data_set</span><span class="si">}</span><span class="s">_03.png</span><span class="sh">"</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">set_colors</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="sh">"</span><span class="s">green</span><span class="sh">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="sh">"</span><span class="s">orange</span><span class="sh">"</span><span class="p">}</span>
        <span class="n">gg</span> <span class="o">=</span> <span class="n">p9</span><span class="p">.</span><span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">facet_grid</span><span class="p">(</span><span class="sh">"</span><span class="s">. ~ set_name</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">scale_color_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">set_colors</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">geom_line</span><span class="p">(</span>
                <span class="n">p9</span><span class="p">.</span><span class="nf">aes</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">epoch</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">n_hidden_layers</span><span class="sh">"</span>
                <span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">loss_df</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">geom_point</span><span class="p">(</span>
                <span class="n">p9</span><span class="p">.</span><span class="nf">aes</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">epoch</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">n_hidden_layers</span><span class="sh">"</span>
                <span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">layers_plot_data</span><span class="p">)</span>
        <span class="n">gg</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">./</span><span class="si">{</span><span class="n">data_set</span><span class="si">}</span><span class="s">_01.png</span><span class="sh">"</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">validation_df</span> <span class="o">=</span> <span class="n">loss_df</span><span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="sh">"</span><span class="s">set_name==</span><span class="sh">'</span><span class="s">validation</span><span class="sh">'"</span><span class="p">)</span>
        <span class="n">min_i</span> <span class="o">=</span> <span class="n">validation_df</span><span class="p">.</span><span class="n">loss</span><span class="p">.</span><span class="nf">argmin</span><span class="p">()</span>
        <span class="n">min_row</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="nf">dict</span><span class="p">(</span><span class="n">validation_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">min_i</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">gg</span> <span class="o">=</span> <span class="n">p9</span><span class="p">.</span><span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">facet_grid</span><span class="p">(</span><span class="sh">"</span><span class="s">. ~ n_hidden_layers</span><span class="sh">"</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">scale_color_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">set_colors</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">scale_fill_manual</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">set_colors</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">geom_line</span><span class="p">(</span>
                <span class="n">p9</span><span class="p">.</span><span class="nf">aes</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">epoch</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">set_name</span><span class="sh">"</span>
                <span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="n">loss_df</span><span class="p">)</span> <span class="o">+</span>\
            <span class="n">p9</span><span class="p">.</span><span class="nf">geom_point</span><span class="p">(</span>
                <span class="n">p9</span><span class="p">.</span><span class="nf">aes</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">epoch</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">loss</span><span class="sh">"</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="sh">"</span><span class="s">set_name</span><span class="sh">"</span>
                <span class="p">),</span>
                <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">min_row</span><span class="p">)</span>
        <span class="n">gg</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">./</span><span class="si">{</span><span class="n">data_set</span><span class="si">}</span><span class="s">_02.png</span><span class="sh">"</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p8_zip_02-480.webp 480w,/assets/img/p8_zip_02-800.webp 800w,/assets/img/p8_zip_02-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p8_zip_02.png" class="img-fluid rounded z-depth-1" width="600px" height="600px" title="threshold_network_full" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h1 id="experiments-and-application">Experiments and Application</h1> <p>This function applies the model to different datasets and compares the performance of various algorithms.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">experiments_and_application</span><span class="p">():</span>
    <span class="n">test_acc_df_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">data_set</span><span class="p">,</span> <span class="p">(</span><span class="n">input_mat</span><span class="p">,</span> <span class="n">output_vec</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="n">k_fold</span> <span class="o">=</span> <span class="nc">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fold_id</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">k_fold</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="n">input_mat</span><span class="p">)):</span>
            <span class="n">index_dict</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="nf">zip</span><span class="p">([</span><span class="sh">"</span><span class="s">train</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">test</span><span class="sh">"</span><span class="p">],</span> <span class="n">indices</span><span class="p">))</span>

            <span class="n">set_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">set_name</span><span class="p">,</span> <span class="n">index_vec</span> <span class="ow">in</span> <span class="n">index_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">set_data_dict</span><span class="p">[</span><span class="n">set_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">X</span><span class="sh">"</span><span class="p">:</span> <span class="n">input_mat</span><span class="p">[</span><span class="n">index_vec</span><span class="p">],</span>
                    <span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">:</span> <span class="n">output_vec</span><span class="p">[</span><span class="n">index_vec</span><span class="p">]</span>
                <span class="p">}</span>

            <span class="n">rmlp</span> <span class="o">=</span> <span class="nc">RegularizedMLP</span><span class="p">(</span>
                <span class="n">max_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                <span class="n">step_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">units_per_hidden_layer</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">learner_instance</span> <span class="o">=</span> <span class="nc">MyCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">rmlp</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="p">[</span>
                                    <span class="p">{</span><span class="sh">'</span><span class="s">hidden_layers</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">L</span><span class="p">]}</span> <span class="k">for</span> <span class="n">L</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">learner_instance</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="o">**</span><span class="n">set_data_dict</span><span class="p">[</span><span class="sh">"</span><span class="s">train</span><span class="sh">"</span><span class="p">])</span>

            <span class="n">logistic_reg_cv</span> <span class="o">=</span> <span class="nc">LogisticRegressionCV</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">logistic_reg_cv</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="o">**</span><span class="n">set_data_dict</span><span class="p">[</span><span class="sh">"</span><span class="s">train</span><span class="sh">"</span><span class="p">])</span>

            <span class="n">grid_search_cv</span> <span class="o">=</span> <span class="nc">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="nc">KNeighborsClassifier</span><span class="p">(),</span> <span class="n">param_grid</span><span class="o">=</span><span class="p">[</span>
                                          <span class="p">{</span><span class="sh">'</span><span class="s">n_neighbors</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">)],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">grid_search_cv</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="o">**</span><span class="n">set_data_dict</span><span class="p">[</span><span class="sh">"</span><span class="s">train</span><span class="sh">"</span><span class="p">])</span>

            <span class="n">featureless</span> <span class="o">=</span> <span class="nc">Featureless</span><span class="p">()</span>
            <span class="n">featureless</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">set_data_dict</span><span class="p">[</span><span class="sh">"</span><span class="s">train</span><span class="sh">"</span><span class="p">][</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">])</span>

            <span class="n">test_data_x</span> <span class="o">=</span> <span class="n">set_data_dict</span><span class="p">[</span><span class="sh">"</span><span class="s">test</span><span class="sh">"</span><span class="p">][</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">test_data_y</span> <span class="o">=</span> <span class="n">set_data_dict</span><span class="p">[</span><span class="sh">"</span><span class="s">test</span><span class="sh">"</span><span class="p">][</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">]</span>

            <span class="n">pred_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">LogisticRegressionCV</span><span class="sh">"</span><span class="p">:</span> <span class="n">logistic_reg_cv</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">test_data_x</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">Featureless</span><span class="sh">"</span><span class="p">:</span> <span class="n">featureless</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">test_data_x</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">GridSearchCV+KNC</span><span class="sh">"</span><span class="p">:</span> <span class="n">grid_search_cv</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">test_data_x</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">MyCV+RegularizedMLP</span><span class="sh">"</span><span class="p">:</span> <span class="n">learner_instance</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">set_data_dict</span><span class="p">[</span><span class="sh">"</span><span class="s">test</span><span class="sh">"</span><span class="p">][</span><span class="sh">'</span><span class="s">X</span><span class="sh">'</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">pred_vec</span> <span class="ow">in</span> <span class="n">pred_dict</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="n">test_acc_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">"</span><span class="s">test_accuracy_percent</span><span class="sh">"</span><span class="p">:</span> <span class="p">(</span><span class="n">pred_vec</span> <span class="o">==</span> <span class="n">test_data_y</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">data_set</span><span class="sh">"</span><span class="p">:</span> <span class="n">data_set</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">fold_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">fold_id</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">algorithm</span><span class="sh">"</span><span class="p">:</span> <span class="n">algorithm</span>
                <span class="p">}</span>
                <span class="n">test_acc_df_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">test_acc_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">test_acc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">test_acc_df_list</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">test_acc_df</span><span class="p">)</span>

    <span class="n">gg</span> <span class="o">=</span> <span class="n">p9</span><span class="p">.</span><span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span>\
        <span class="n">p9</span><span class="p">.</span><span class="nf">geom_point</span><span class="p">(</span>
            <span class="n">p9</span><span class="p">.</span><span class="nf">aes</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">test_accuracy_percent</span><span class="sh">"</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="sh">"</span><span class="s">algorithm</span><span class="sh">"</span>
            <span class="p">),</span>
            <span class="n">data</span><span class="o">=</span><span class="n">test_acc_df</span><span class="p">)</span> <span class="o">+</span>\
        <span class="n">p9</span><span class="p">.</span><span class="nf">facet_wrap</span><span class="p">(</span><span class="sh">"</span><span class="s">data_set</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">gg</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="sh">"</span><span class="s">./p8_accuracy_facetted.png</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/p8_accuracy_facetted-480.webp 480w,/assets/img/p8_accuracy_facetted-800.webp 800w,/assets/img/p8_accuracy_facetted-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/p8_accuracy_facetted.png" class="img-fluid rounded z-depth-1" width="600px" height="600px" title="threshold_network_full" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h1 id="conclusion">Conclusion</h1> <p>This pipeline integrates various components of machine learning workflow, including data preparation, model building, training, hyperparameter tuning, and result visualization. The use of custom classes and functions allows for flexibility and reusability in different machine learning scenarios. This project post aims to provide a comprehensive overview and a practical implementation guide for building a machine learning pipeline from scratch.</p> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Daniel Agyapong. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>